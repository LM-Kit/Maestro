@inject ModelListViewModel ModelListViewModel


<MudStack Spacing="@(Dense ? 0 : 5)">
    @foreach (var modelItem in _modelItems)
    {
        <ListItemWrapper LimitWidth="LimitWidth" ListItemViewModel="modelItem">
            <ChildContent>
                <div @onclick="() => OnClick.InvokeAsync(modelItem.ViewModel)">
                    <ModelCard IsFocused="modelItem.IsShowingActionSheet || modelItem.IsHovered" Dense="Dense" Selectable="Selectable" ViewModel="modelItem.ViewModel" />
                </div>
            </ChildContent>

            <ActionSheet>
                <div class="d-flex flex-column">
                    <MudButton Class="action-button" Variant="Variant.Text"
                               @onclick="() => HandleActionButtonClick(() => ModelListViewModel.OpenModelInExplorer(modelItem.ViewModel), modelItem)">
                        <MudText Typo="Typo.subtitle2">Reveal in explorer</MudText>
                    </MudButton>

                    <MudButton Class="action-button" Variant="Variant.Text"
                               @onclick="() => HandleActionButtonClick(() => ModelListViewModel.OpenModelHfLink(modelItem.ViewModel), modelItem)">
                        <MudText Typo="Typo.subtitle2">Open on Hugging Face</MudText>
                    </MudButton>

                    @if (modelItem.ViewModel.IsLocallyAvailable)
                    {
                        <MudButton Class="action-button" Variant="Variant.Text"
                                   @onclick="() => HandleActionButtonClick(() => ModelListViewModel.DeleteModel(modelItem.ViewModel), modelItem)">
                            <MudText Color="Color.Error" Typo="Typo.subtitle2">Delete from disk</MudText>
                        </MudButton>
                    }
                </div>
            </ActionSheet>
        </ListItemWrapper>
    }
</MudStack>


<style>
    .item-actions {
        background-color: var(--Surface);
        border-radius: 0.25rem;
        border: 1px solid var(--OutlineVariant);
    }

    .action-button {
        border-radius: 0.25rem;
    }

        .action-button:hover {
            background-color: var(--Surface2) !important;
        }
</style>

@code {
    private ObservableCollection<ListItemViewModel<ModelInfoViewModel>> _modelItems = new();
    [Parameter] public EventCallback<ModelInfoViewModel> OnClick { get; set; }

    private bool _dense;
    [Parameter]
    public bool Dense
    {
        get => _dense;
        set
        {
            if (value != _dense)
            {
                _dense = value;
                InvokeAsync(() => StateHasChanged());
            }
        }
    }

    public bool _selectable;
    [Parameter]
    public bool Selectable
    {
        get => _selectable;
        set
        {
            if (value != _selectable)
            {
                _selectable = value;
                InvokeAsync(() => StateHasChanged());
            }
        }
    }

    private bool _limitWidth;
    [Parameter]
    public bool LimitWidth
    {
        get => _limitWidth;
        set
        {
            if (value != _limitWidth)
            {
                _limitWidth = value;
                InvokeAsync(() => StateHasChanged());
            }
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();

        UpdateModels();

        ModelListViewModel.Models.CollectionChanged += OnModelsChanged;
    }

    private void OnModelsChanged(object? sender, NotifyCollectionChangedEventArgs e)
    {
        InvokeAsync(UpdateModels);
    }

    private void UpdateModels()
    {
        _modelItems.Clear();

        foreach (var model in ModelListViewModel.Models)
        {
            _modelItems.Add(new ListItemViewModel
                <ModelInfoViewModel>(model));
        }

        InvokeAsync(StateHasChanged);
    }

    private void HandleActionButtonClick(Action action, ListItemViewModel<ModelInfoViewModel> modelItem)
    {
        action.Invoke();
        modelItem.IsShowingActionSheet = false;

        InvokeAsync(StateHasChanged);
    }
}
