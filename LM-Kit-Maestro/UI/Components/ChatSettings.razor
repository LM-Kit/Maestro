@inject ThemeService ThemeService
@inject IJSRuntime JS
@inherits ComponentBase

<div id="settings-container">
    <Expander Title="Appearance">
        <MudStack Class="pa-2" Spacing="4">
            <MudText Typo="Typo.overline">Theme color</MudText>
            <div class="theme-color-picker">
                @foreach (var theme in ThemePresets.All)
                {
                    <button class="theme-color-btn @(ThemeService.CurrentTheme.Name == theme.Name ? "selected" : "")"
                            style="background: linear-gradient(135deg, @theme.Primary 0%, @theme.Accent 100%);"
                            title="@theme.Name"
                            @onclick="() => SelectTheme(theme)">
                        @if (ThemeService.CurrentTheme.Name == theme.Name)
                        {
                            <i class="fas fa-check"></i>
                        }
                    </button>
                }
            </div>
        </MudStack>
    </Expander>
    <MudDivider />

    <Expander Title="Storage">
        <div class="storage-settings">
            <div class="storage-item">
                <div class="storage-header">
                    <div class="storage-icon">
                        <i class="fas fa-cube"></i>
                    </div>
                    <div class="storage-info">
                        <span class="storage-label">Model Storage</span>
                        <span class="storage-description">Where AI models are downloaded and stored</span>
                    </div>
                </div>
                <div class="storage-path-row">
                    <input type="text" 
                           class="storage-path-input" 
                           value="@ViewModel.ModelStorageDirectory"
                           @onchange="OnModelStoragePathChanged"
                           title="@ViewModel.ModelStorageDirectory" />
                    <button class="storage-browse-btn" @onclick="BrowseModelStorage" title="Browse for folder">
                        <i class="fas fa-folder-open"></i>
                    </button>
                </div>
            </div>

            <div class="storage-divider"></div>

            <div class="storage-item">
                <div class="storage-header">
                    <div class="storage-icon">
                        <i class="fas fa-clock-rotate-left"></i>
                    </div>
                    <div class="storage-info">
                        <span class="storage-label">Chat History</span>
                        <span class="storage-description">Where conversation history is saved</span>
                    </div>
                </div>
                <div class="storage-path-row">
                    <input type="text" 
                           class="storage-path-input" 
                           value="@ViewModel.ChatHistoryDirectory"
                           @onchange="OnChatHistoryPathChanged"
                           title="@ViewModel.ChatHistoryDirectory" />
                    <button class="storage-browse-btn" @onclick="BrowseChatHistory" title="Browse for folder">
                        <i class="fas fa-folder-open"></i>
                    </button>
                </div>
            </div>

            <div class="storage-note">
                <i class="fas fa-circle-info"></i>
                <span>Changes to chat history location require restart</span>
            </div>
        </div>
    </Expander>
    <MudDivider />

    <Expander Title="General settings">
        <MudStack Class="pa-2" Spacing="6">
            <div class="d-flex flex-column gap-2">

                <div class="d-flex flex-row justify-content-around">

                    <MudText Typo="Typo.overline">
                        Chatbot purpose
                    </MudText>

                    @if (ViewModel.SystemPrompt != LMKitDefaultSettings.DefaultSystemPrompt)
                    {
                        <IconButton Style="IconButton.ButtonStyle.Icon"
                                    Icon="fas fa-rotate-left"
                                    OnClick="OnResetSystemPromptClicked" />
                    }

                </div>

                <MudTextField Variant="Variant.Outlined"
                              @onfocusout="OnChatbotPurposeInputFocusOut"
                              Style="--mud-palette-primary: var(--Secondary)"
                              Typo="Typo.caption"
                              Lines="5"
                              @bind-Value="ChatbotPurposeInput" />
            </div>

            <div class="d-flex justify-content-between align-center">
                <div class="d-flex align-center flex-grow-1 overflow-hidden">
                    <MudText Typo="Typo.overline" Class="text-truncate">Limit response length</MudText>
                    <MudSwitch UncheckedColor="Color.Secondary" Color="Color.Secondary" Ripple="false" Size="Size.Small"
                               @bind-Value="LimitRespongeLength" />
                </div>

                <div class="flex-shrink-0">
                    @if (LimitRespongeLength)
                    {
                        <NumericTextField @bind-Value="ViewModel.MaximumCompletionTokens" MinValue="1" MaxValue="2048" />
                    }
                </div>
            </div>

            @if (LimitRespongeLength)
            {
                <div>
                    <MudText Class="text-truncate"
                             Typo="Typo.overline">
                        Maximum number of tokens
                    </MudText>

                    <MudSlider @bind-Value="ViewModel.MaximumCompletionTokens"
                               Min="1"
                               Max="2048"
                               Color="Color.Secondary" />
                </div>
            }

            <NumericSetting @bind-Value="ViewModel.RequestTimeout"
                            Title="Request timeout (sec)"
                            MinValue="10"
                            MaxValue="120" />

            <NumericSetting @bind-Value="ViewModel.ContextSize"
                            Title="Context size"
                            MinValue="512"
                            MaxValue="32768" />
        </MudStack>
    </Expander>
    <MudDivider />

    <Expander Title="Sampling configuration">
        <MudStack Class="pa-2" Spacing="6">
            <div class="d-flex flex-row justify-space-between align-center">
                <MudText Class="text-truncate"
                         Typo="Typo.overline">
                    Sampling mode
                </MudText>

                <MudSpacer />

                <MudSelect Typo="Typo.caption"
                           Adornment="Adornment.None"
                           @bind-Value="ViewModel.SamplingMode"
                           Style="--mud-palette-primary: var(--Secondary)">
                    @foreach (var value in Enum.GetValues<SamplingMode>())
                    {
                        <MudSelectItem Style="--mud-palette-primary: var(--Secondary)" Value="@value">
                            <MudText Typo="Typo.caption">
                                @value
                            </MudText>
                        </MudSelectItem>
                    }
                </MudSelect>
            </div>

            @if (ViewModel.SamplingMode == SamplingMode.Random)
            {
                <NumericSetting @bind-Value="ViewModel.RandomSamplingSettings.Temperature"
                                Title="Temperature"
                                MinValue="0"
                                MaxValue="1" />

                <NumericSetting @bind-Value="ViewModel.RandomSamplingSettings.DynamicTemperatureRange"
                                Title="Dynamic temperature range"
                                MinValue="0"
                                MaxValue="1" />

                <NumericSetting @bind-Value="ViewModel.RandomSamplingSettings.TopP"
                                Title="Top P"
                                MinValue="0"
                                MaxValue="1" />

                <NumericSetting @bind-Value="ViewModel.RandomSamplingSettings.TopK"
                                Title="Top K"
                                MinValue="1"
                                MaxValue="1000" />

                /*<NumericSetting @bind-Value="ViewModel.RandomSamplingSettings.LocallyTypical"
                                Title="Locally typical"
                                MinValue="0"
                                MaxValue="1" />*/
            }
            else if (ViewModel.SamplingMode == SamplingMode.TopNSigma)
            {
                <NumericSetting @bind-Value="ViewModel.TopNSigmaSamplingSettings.Temperature"
                                Title="Temperature"
                                MinValue="0"
                                MaxValue="1" />

                <NumericSetting @bind-Value="ViewModel.TopNSigmaSamplingSettings.TopNSigma"
                                Title="Top-nÏƒ threshold"
                                MinValue="0"
                                MaxValue="5" />

                <NumericSetting @bind-Value="ViewModel.TopNSigmaSamplingSettings.TopK"
                                Title="Top K"
                                MinValue="1"
                                MaxValue="1000" />

            }
            else if (ViewModel.SamplingMode == SamplingMode.Mirostat2)
            {
                <NumericSetting @bind-Value="ViewModel.Mirostat2SamplingSettings.Temperature"
                                Title="Temperature"
                                MinValue="0"
                                MaxValue="1" />

                <NumericSetting @bind-Value="ViewModel.Mirostat2SamplingSettings.TargetEntropy"
                                Title="Target entropy"
                                MinValue="0"
                                MaxValue="10" />

                <NumericSetting @bind-Value="ViewModel.Mirostat2SamplingSettings.LearningRate"
                                Title="Learning rate"
                                MinValue="0"
                                MaxValue="1" />
            }

        </MudStack>
    </Expander>
    <MudDivider />
</div>

@code
{
    [Parameter] public ChatSettingsViewModel ViewModel { get; set; }

    private int? _previousTokenLimit;

    private bool _limitResponseLength = false;

    bool LimitRespongeLength
    {
        get => _limitResponseLength;
        set
        {
            if (_limitResponseLength != value)
            {
                _limitResponseLength = value;
                InvokeAsync(() => StateHasChanged());

                if (!value)
                {
                    _previousTokenLimit = ViewModel.MaximumCompletionTokens;
                    ViewModel.MaximumCompletionTokens = -1;
                }
                else
                {
                    if (ViewModel.MaximumCompletionTokens == -1)
                    {
                        ViewModel.MaximumCompletionTokens = _previousTokenLimit != null ? _previousTokenLimit.Value : 2048;
                    }
                }
            }
        }
    }

    private string _chatbotPurposeInput = "";

    private string ChatbotPurposeInput
    {
        get => _chatbotPurposeInput;
        set
        {
            if (_chatbotPurposeInput != value)
            {
                _chatbotPurposeInput = value;
                InvokeAsync(() => StateHasChanged());
            }
        }
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        LimitRespongeLength = ViewModel.MaximumCompletionTokens != -1;
        ChatbotPurposeInput = ViewModel.SystemPrompt;
    }

    private void OnChatbotPurposeInputFocusOut()
    {
        if (!string.IsNullOrWhiteSpace(ChatbotPurposeInput))
        {
            ViewModel.SystemPrompt = ChatbotPurposeInput.Trim();
        }

        ChatbotPurposeInput = ViewModel.SystemPrompt;
    }

    private void OnResetSystemPromptClicked()
    {
        ViewModel.ResetSystemPrompt();
        ChatbotPurposeInput = ViewModel.SystemPrompt;
    }

    private async Task SelectTheme(ThemePreset theme)
    {
        ThemeService.SetTheme(theme);
        await JS.InvokeVoidAsync("localStorage.setItem", "maestro-theme", theme.Name);
        StateHasChanged();
    }

    private async Task BrowseModelStorage()
    {
        try
        {
            var result = await FolderPicker.Default.PickAsync(CancellationToken.None);
            if (result.IsSuccessful && !string.IsNullOrEmpty(result.Folder?.Path))
            {
                ViewModel.SetModelStorageDirectory(result.Folder.Path);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Folder picker error: {ex.Message}");
        }
    }

    private async Task BrowseChatHistory()
    {
        try
        {
            var result = await FolderPicker.Default.PickAsync(CancellationToken.None);
            if (result.IsSuccessful && !string.IsNullOrEmpty(result.Folder?.Path))
            {
                ViewModel.SetChatHistoryDirectory(result.Folder.Path);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Folder picker error: {ex.Message}");
        }
    }

    private void OnModelStoragePathChanged(ChangeEventArgs e)
    {
        var path = e.Value?.ToString();
        if (!string.IsNullOrWhiteSpace(path))
        {
            ViewModel.SetModelStorageDirectory(path);
            StateHasChanged();
        }
    }

    private void OnChatHistoryPathChanged(ChangeEventArgs e)
    {
        var path = e.Value?.ToString();
        if (!string.IsNullOrWhiteSpace(path))
        {
            ViewModel.SetChatHistoryDirectory(path);
            StateHasChanged();
        }
    }
}
