@page "/chat"

@inject LMKitService LMKitService
@inject HttpClient Http
@inject IJSRuntime JS
@inject IScrollHandler ScrollHandler
@inject IResizeHandler ResizeHandler
@inject ILogger<ChatPage> Logger
@inject ISnackbarService SnackbarService
@inject IDialogService DialogService


@inherits MvvmComponentBase<ChatPageViewModel>

<SectionContent SectionName="nav-bar-top">
    @if (!ChatsSidebarIsToggled)
    {
        <div class="nav-item" title="Open sidebar">
            <button class="nav-link" @onclick="ToggleChatsSidebar">
                <MudIcon Icon="@Icons.Material.Outlined.Menu" />
            </button>
        </div>
        <div class="nav-item" title="New chat">
            <button class="nav-link nav-link-bordered" @onclick="OnNewChatClicked">
                <MudIcon Icon="@Icons.Material.Outlined.Add" />
            </button>
        </div>
    }
</SectionContent>

<SectionContent SectionName="nav-bar-bottom">
    @if (!ChatsSidebarIsToggled)
    {
        <div class="nav-item" title="Settings">
            <button class="nav-link @(SettingsSidebarIsToggled ? "nav-link-active" : "")" @onclick="ToggleSettingsSidebar">
                <MudIcon Icon="@Icons.Material.Outlined.Tune" />
            </button>
        </div>
    }
</SectionContent>

<div id="chat-container">
    <ChatSidebar ShowScrollbar="true"
        Resizable="true"
        Position="ChatSidebar.SidebarPosition.Left"
        @bind-Width="ChatsSidebarWidth"
        @bind-IsResizing="ChatsSidebarIsResizing"
        @bind-IsToggled="ChatsSidebarIsToggled">

        <div class="sidebar-header">
            <span class="sidebar-title">Maestro <span class="maestro-heart">‚ù§</span></span>
            <button class="sidebar-close-button" @onclick="ToggleChatsSidebar" title="Close sidebar">
                <i class="fas fa-xmark"></i>
            </button>
        </div>

        <div class="sidebar-actions">
            <button class="sidebar-action-button" @onclick="OnNewChatClicked">
                <i class="fas fa-plus"></i>
                <span>New chat</span>
            </button>
        </div>

        @if (ViewModel.ConversationListViewModel.HasStarredConversations)
        {
            <div class="sidebar-section-title">
                <i class="fas fa-star" style="font-size: 0.625rem; color: #FBBF24; margin-right: 0.375rem;"></i>
                Starred
            </div>

            <div class="sidebar-conversations">
                @foreach (var conversation in ViewModel.ConversationListViewModel.StarredConversations)
                {
                    <ConversationListItem OnSelect="OnConversationItemSelected"
                                          OnDelete="OnConversationItemDeleteClicked"
                                          OnToggleStar="OnConversationItemStarToggled"
                                          IsSelected="@(conversation == ViewModel.ConversationListViewModel.CurrentConversation)"
                                          ViewModel="conversation"/>
                }
            </div>

            <div class="sidebar-section-title">Recent</div>
        }
        else
        {
            <div class="sidebar-section-title">Chats</div>
        }

        <div class="sidebar-conversations">
            @foreach (var conversation in ViewModel.ConversationListViewModel.RecentConversations)
            {
                <ConversationListItem OnSelect="OnConversationItemSelected"
                                      OnDelete="OnConversationItemDeleteClicked"
                                      OnToggleStar="OnConversationItemStarToggled"
                                      IsSelected="@(conversation == ViewModel.ConversationListViewModel.CurrentConversation)"
                                      ViewModel="conversation"/>
            }
        </div>

        <div class="sidebar-footer">
            <button class="sidebar-footer-button @(SettingsSidebarIsToggled ? "active" : "")" @onclick="ToggleSettingsSidebar">
                <i class="fas fa-bars-staggered"></i>
                <span>Configuration</span>
            </button>
        </div>
    </ChatSidebar>


    <div id="chat-body">
        <div id="chat-top-bar">
            <ModelSelectionButton ModelListViewModel="ViewModel.ModelListViewModel"/>
        </div>

        <div id="chat-content">
            @if (ViewModel?.ConversationListViewModel.CurrentConversation != null)
            {
                if (ViewModel.ConversationListViewModel.CurrentConversation.IsEmpty)
                {
                    <div id="empty-chat-container">
                        <div id="empty-chat-content" class="chat-element">
                            <h1 class="welcome-title">What can I help with?</h1>
                            <div id="empty-chat-input">
                                <ChatInput ViewModel="ViewModel!.ConversationListViewModel.CurrentConversation"/>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div id="conversation-content" class="hover-scrollable">
                        <div id="chat-messages" class="chat-element">
                            @foreach (var message in ViewModel.ConversationListViewModel.CurrentConversation.Messages)
                            {
                                <ChatMessage MessageViewModel="message"/>
                            }

                        <div id="chat-messages-bottom-space">
                            <div id="scroll-to-end">
                                @if (!IsScrolledToEnd)
                                {
                                    <button @onclick="OnScrollToEndButtonClicked"
                                            class="scroll-to-end-button">
                                        <span><i class="fas fa-arrow-down"></i></span>
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <div id="user-input" class="chat-element">
                    <ChatInput ViewModel="ViewModel!.ConversationListViewModel.CurrentConversation"/>
                </div>

                <div id="bottom-space">
                    @if (ViewModel?.ConversationListViewModel?.CurrentConversation?.LMKitConversation?.ContextSize > 0)
                    {
                        <MudText Style="font-size:0.7rem" Align="Align.Center" Typo="Typo.overline">
                            Tokens: @ViewModel.ConversationListViewModel.CurrentConversation.LMKitConversation.ContextUsedSpace /
                            @ViewModel.ConversationListViewModel.CurrentConversation.LMKitConversation.ContextSize
                            (@CalculateUsagePercentage(ViewModel.ConversationListViewModel.CurrentConversation.LMKitConversation.ContextUsedSpace,
                                     ViewModel.ConversationListViewModel.CurrentConversation.LMKitConversation.ContextSize)%)
                        </MudText>
                    }
                </div>
            }
        }
        </div>
    </div>

    <ChatSidebar ShowScrollbar="false"
                 Resizable="true"
                 Position="ChatSidebar.SidebarPosition.Right"
                 @bind-Width="SettingsSidebarWidth"
                 @bind-IsResizing="SettingsSidebarIsResizing"
                 @bind-IsToggled="SettingsSidebarIsToggled">
        <div class="sidebar-header sidebar-header-settings">
            <span class="sidebar-title">Configuration</span>
            <div class="sidebar-header-actions">
                <button class="sidebar-header-button" @onclick="OnResetSettingsClicked" title="Reset to defaults">
                    <i class="fas fa-rotate-left"></i>
                </button>
                <button class="sidebar-close-button" @onclick="ToggleSettingsSidebar" title="Close">
                    <i class="fas fa-xmark"></i>
                </button>
            </div>
        </div>
        <div class="sidebar-settings-content">
            <ChatSettings ViewModel="ViewModel!.ChatSettingsViewModel"/>
        </div>
    </ChatSidebar>
</div>
